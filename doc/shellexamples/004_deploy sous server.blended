
bash-3.2$ sous config
StateLocation: /Users/jlester/.local/share/sous/state
Server: ""
SiblingURLs: {}
BuildStateDir: ""
Docker:
  RegistryHost: 192.168.99.100:5000
  DatabaseDriver: sqlite3_sous
  DatabaseConnection: file:dummy.db?mode=memory&cache=shared
User:
  Name: ""
  Email: ""
bash-3.2$ cat ~/.config/sous/config.yaml
Docker:
  RegistryHost: 192.168.99.100:5000
bash-3.2$ git clone ssh://root@192.168.99.100:2222/repos/sous-server
Cloning into 'sous-server'...
Warning: Permanently added '[192.168.99.100]:2222' (ECDSA) to the list of known hosts.
bash-3.2$ pushd sous-server
/tmp/sous-work/sous-server /tmp/sous-work
bash-3.2$ export SOUS_USER_NAME=test SOUS_USER_EMAIL=test@test.com
bash-3.2$ export SOUS_SERVER= SOUS_STATE_LOCATION=/tmp/sous-work/gdm
bash-3.2$ 
bash-3.2$ sous init
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm
Source: 192.168.99.100/2222/repos/sous-server
Owners: []
Kind: http-service
Deployments:
  left:
    Resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    NumInstances: 1
    Volumes: []
    Version: 0.0.0
  right:
    Resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    NumInstances: 1
    Volumes: []
    Version: 0.0.0
bash-3.2$ sous manifest get
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm
source: 192.168.99.100/2222/repos/sous-server
owners: []
kind: http-service
deployments:
  left:
    resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    numinstances: 1
    volumes: []
    version: 0.0.0
  right:
    resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    numinstances: 1
    volumes: []
    version: 0.0.0

bash-3.2$ sous manifest set < ~/templated-configs/sous-server.yaml
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm

bash-3.2$ sous manifest get # demonstrating this got to GDM
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm
source: 192.168.99.100/2222/repos/sous-server
owners:
- test@test.com
kind: http-service
deployments:
  left:
    resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    env:
      GDM_REPO: ssh://root@192.168.99.100:2222/repos/gdm
      SOUS_DOCKER_REGISTRY_HOST: 192.168.99.100:5000
    numinstances: 1
    volumes: []
    version: 0.0.0
  right:
    resources:
      cpus: "0.1"
      memory: "100"
      ports: "1"
    env:
      GDM_REPO: ssh://root@192.168.99.100:2222/repos/gdm
      SOUS_DOCKER_REGISTRY_HOST: 192.168.99.100:5000
    numinstances: 1
    volumes: []
    version: 0.0.0

bash-3.2$ 
bash-3.2$ # Last minute config
bash-3.2$ cat Dockerfile
FROM golang:1.7

# Add deploy key.
COPY ./key_sous@example.com /root/.ssh/id_rsa
COPY ./known_hosts /root/.ssh/known_hosts
COPY ./docker.crt /docker.crt

RUN chmod -R og-rwx /root/.ssh

COPY ./sous /go/bin/sous

COPY main.go /go/src/github.com/opentable/sous-server/
WORKDIR /go/src/github.com/opentable/sous-server
RUN go install -v

# Run sous server.
# NOTE: You must have set PORT0, GDM_REPO
CMD /go/bin/sous-server
bash-3.2$ cp ~/dot-ssh/git_pubkey_rsa key_sous@example.com
bash-3.2$ cp /Users/jlester/golang/src/github.com/opentable/sous/dev_support/</golang/src/github.com/opentable/sous/dev_support/$                         (readlink /Users/jlester/<ntable/sous/dev_support/$(readlink /Users/jlester/g                         olang/src/github.com/open<readlink /Users/jlester/golang/src/github.com/opent                         able/sous/dev_support/sou<lang/src/github.com/opentable/sous/dev_support/sous                         _linux) .
bash-3.2$ cp /Users/jlester/golang/src/github.com/opentable/sous/integration/</golang/src/github.com/opentable/sous/integration/t                         est-registry/docker-regis<ntable/sous/integration/test-registry/docker-regist                         ry/testing.crt docker.crt
bash-3.2$ 
bash-3.2$ ls -a
.
..
.git
Dockerfile
docker.crt
key_sous@example.com
main.go
sous
sous-server.yaml
bash-3.2$ ssh-keyscan -p 2222 192.168.99.100 > known_hosts
# 192.168.99.100:2222 SSH-2.0-OpenSSH_7.2p2-hpn14v4
# 192.168.99.100:2222 SSH-2.0-OpenSSH_7.2p2-hpn14v4
# 192.168.99.100:2222 SSH-2.0-OpenSSH_7.2p2-hpn14v4
bash-3.2$ 
bash-3.2$ git add key_sous@example.com known_hosts sous
bash-3.2$ git commit -am "Adding ephemeral files"
[master 35a9a82] Adding ephemeral files
 3 files changed, 30 insertions(+)
 create mode 100644 key_sous@example.com
 create mode 100644 known_hosts
 create mode 100755 sous
bash-3.2$ git tag -am "0.0.2" 0.0.2
bash-3.2$ git push
Warning: Permanently added '[192.168.99.100]:2222' (ECDSA) to the list of known hosts.
To ssh://192.168.99.100:2222/repos/sous-server
   bdfdd3f..35a9a82  master -> master
bash-3.2$ git push --tags
Warning: Permanently added '[192.168.99.100]:2222' (ECDSA) to the list of known hosts.
To ssh://192.168.99.100:2222/repos/sous-server
 * [new tag]         0.0.2 -> 0.0.2
bash-3.2$ 
bash-3.2$ sous build
  (Sous)> running docker build .
  (Sous)>   Sending build context to Docker daemon 30.65 MB
  (Sous)>   Step 1/10 : FROM golang:1.7
  (Sous)>    ---> 7afbc2b03b9e
  (Sous)>   Step 2/10 : COPY ./key_sous@example.com /root/.ssh/id_rsa
  (Sous)>    ---> Using cache
  (Sous)>    ---> e275d60882b0
  (Sous)>   Step 3/10 : COPY ./known_hosts /root/.ssh/known_hosts
  (Sous)>    ---> Using cache
  (Sous)>    ---> 690ac918f7ce
  (Sous)>   Step 4/10 : COPY ./docker.crt /docker.crt
  (Sous)>    ---> Using cache
  (Sous)>    ---> 931e84f62da9
  (Sous)>   Step 5/10 : RUN chmod -R og-rwx /root/.ssh
  (Sous)>    ---> Using cache
  (Sous)>    ---> 1935825e4b5a
  (Sous)>   Step 6/10 : COPY ./sous /go/bin/sous
  (Sous)>    ---> dad0b8412d66
  (Sous)>   Removing intermediate container ccd7d8f6cd3e
  (Sous)>   Step 7/10 : COPY main.go /go/src/github.com/opentable/sous-server/
  (Sous)>    ---> 69ba0e93f2f1
  (Sous)>   Removing intermediate container b889f5242543
  (Sous)>   Step 8/10 : WORKDIR /go/src/github.com/opentable/sous-server
  (Sous)>    ---> 05e0c1fd33af
  (Sous)>   Removing intermediate container 51c449ebfe26
  (Sous)>   Step 9/10 : RUN go install -v
  (Sous)>    ---> Running in 1963ba953d50
  (Sous)>   [91mgithub.com/opentable/sous-server
  (Sous)>   [0m ---> 5fb5e669bfe8
  (Sous)>   Removing intermediate container 1963ba953d50
  (Sous)>   Step 10/10 : CMD /go/bin/sous-server
  (Sous)>    ---> Running in 95361a777978
  (Sous)>    ---> 77e0fdb661db
  (Sous)>   Removing intermediate container 95361a777978
  (Sous)>   Successfully built 77e0fdb661db
  (Sous)> running docker build -t 192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:0.0.2 -t 192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:35a9a823c64fc282474b4cc3de12abd8a5b9082b -
  (Sous)>   Sending build context to Docker daemon 2.048 kB
  (Sous)>   Step 1/2 : FROM 77e0fdb661db
  (Sous)>    ---> 77e0fdb661db
  (Sous)>   Step 2/2 : LABEL com.opentable.sous.repo_offset "" com.opentable.sous.repo_url "192.168.99.100/2222/repos/sous-server" com.opentable.sous.revision "35a9a823c64fc282474b4cc3de12abd8a5b9082b" com.opentable.sous.version "0.0.2" com.opentable.sous.advisories "dirty workspace"
  (Sous)>    ---> Running in 54f93b6ceccf
  (Sous)>    ---> 434a6dfaaaa6
  (Sous)>   Removing intermediate container 54f93b6ceccf
  (Sous)>   Successfully built 434a6dfaaaa6
warn: build may not be deployable in all clusters due to advisories:
  dirty workspace
  (Sous)> running docker push 192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:0.0.2
  (Sous)>   The push refers to a repository [192.168.99.100:5000/192.168.99.100/2222/repos/sous-server]
  (Sous)>   ca9e94b3a3ba: Preparing
  (Sous)>   fbd22a24d707: Preparing
  (Sous)>   ba37b47c1a46: Preparing
  (Sous)>   7eb6d3ef3b8a: Preparing
  (Sous)>   9839846a8eda: Preparing
  (Sous)>   08d886f73be4: Preparing
  (Sous)>   269c96c6b1a0: Preparing
  (Sous)>   8eb1c995f8b9: Preparing
  (Sous)>   677062ced7d3: Preparing
  (Sous)>   d23a95ba38e5: Preparing
  (Sous)>   f4d2be23d596: Preparing
  (Sous)>   30339f20ced0: Preparing
  (Sous)>   0eb22bfb707d: Preparing
  (Sous)>   a2ae92ffcd29: Preparing
  (Sous)>   08d886f73be4: Waiting
  (Sous)>   269c96c6b1a0: Waiting
  (Sous)>   8eb1c995f8b9: Waiting
  (Sous)>   677062ced7d3: Waiting
  (Sous)>   d23a95ba38e5: Waiting
  (Sous)>   f4d2be23d596: Waiting
  (Sous)>   30339f20ced0: Waiting
  (Sous)>   0eb22bfb707d: Waiting
  (Sous)>   a2ae92ffcd29: Waiting
  (Sous)>   9839846a8eda: Layer already exists
  (Sous)>   7eb6d3ef3b8a: Layer already exists
  (Sous)>   08d886f73be4: Layer already exists
  (Sous)>   269c96c6b1a0: Layer already exists
  (Sous)>   8eb1c995f8b9: Layer already exists
  (Sous)>   d23a95ba38e5: Layer already exists
  (Sous)>   677062ced7d3: Layer already exists
  (Sous)>   f4d2be23d596: Layer already exists
  (Sous)>   30339f20ced0: Layer already exists
  (Sous)>   0eb22bfb707d: Layer already exists
  (Sous)>   fbd22a24d707: Pushed
  (Sous)>   a2ae92ffcd29: Layer already exists
  (Sous)>   ca9e94b3a3ba: Pushed
  (Sous)>   ba37b47c1a46: Pushed
  (Sous)>   0.0.2: digest: sha256:8c6d513c07eabd2469d94e774653d0f008a1445a85bb05c7a86e5a7250203f4f size: 3252
  (Sous)> running docker push 192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:35a9a823c64fc282474b4cc3de12abd8a5b9082b
  (Sous)>   The push refers to a repository [192.168.99.100:5000/192.168.99.100/2222/repos/sous-server]
  (Sous)>   ca9e94b3a3ba: Preparing
  (Sous)>   fbd22a24d707: Preparing
  (Sous)>   ba37b47c1a46: Preparing
  (Sous)>   7eb6d3ef3b8a: Preparing
  (Sous)>   9839846a8eda: Preparing
  (Sous)>   08d886f73be4: Preparing
  (Sous)>   269c96c6b1a0: Preparing
  (Sous)>   8eb1c995f8b9: Preparing
  (Sous)>   677062ced7d3: Preparing
  (Sous)>   d23a95ba38e5: Preparing
  (Sous)>   f4d2be23d596: Preparing
  (Sous)>   30339f20ced0: Preparing
  (Sous)>   0eb22bfb707d: Preparing
  (Sous)>   a2ae92ffcd29: Preparing
  (Sous)>   08d886f73be4: Waiting
  (Sous)>   8eb1c995f8b9: Waiting
  (Sous)>   269c96c6b1a0: Waiting
  (Sous)>   d23a95ba38e5: Waiting
  (Sous)>   f4d2be23d596: Waiting
  (Sous)>   30339f20ced0: Waiting
  (Sous)>   0eb22bfb707d: Waiting
  (Sous)>   a2ae92ffcd29: Waiting
  (Sous)>   ca9e94b3a3ba: Layer already exists
  (Sous)>   fbd22a24d707: Layer already exists
  (Sous)>   ba37b47c1a46: Layer already exists
  (Sous)>   9839846a8eda: Layer already exists
  (Sous)>   8eb1c995f8b9: Layer already exists
  (Sous)>   08d886f73be4: Layer already exists
  (Sous)>   7eb6d3ef3b8a: Layer already exists
  (Sous)>   269c96c6b1a0: Layer already exists
  (Sous)>   677062ced7d3: Layer already exists
  (Sous)>   d23a95ba38e5: Layer already exists
  (Sous)>   0eb22bfb707d: Layer already exists
  (Sous)>   f4d2be23d596: Layer already exists
  (Sous)>   30339f20ced0: Layer already exists
  (Sous)>   a2ae92ffcd29: Layer already exists
  (Sous)>   35a9a823c64fc282474b4cc3de12abd8a5b9082b: digest: sha256:8c6d513c07eabd2469d94e774653d0f008a1445a85bb05c7a86e5a7250203f4f size: 3252
  (Sous)> [recording "192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:0.0.2" as the docker name for "192.168.99.100/2222/repos/sous-server,0.0.2+35a9a823c64fc282474b4cc3de12abd8a5b9082b"]
Built: "192.168.99.100:5000/192.168.99.100/2222/repos/sous-server:0.0.2"
Advisories:
  dirty workspace
Elapsed: 4.258434549s
bash-3.2$ sous deploy -cluster left # We expect to see 'Sous is running ... i<ter left # We expect to see 'Sous is running ... in                          workstation mode' here:
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm
Updated global manifest.
2017/02/24 12:56:01 ads.go:37: Getting all requests...
2017/02/24 12:56:01 coaxerconfig.go:15: Running: get requests from cluster "left" (attempt 1)
2017/02/24 12:56:01 coaxerconfig.go:15: Success: get requests from cluster "left" at attempt 1
2017/02/24 12:56:01 ads.go:68: Success: got all requests from cluster "left"
2017/02/24 12:56:01 ads.go:72: Got: 0 requests

bash-3.2$ sous deploy -cluster right
warn: No server set, Sous is running in server or workstation mode.
warn: Configure a server like this: sous config server http://some.sous.server
warn: Using local state stored at /tmp/sous-work/gdm
Updated global manifest.
2017/02/24 12:56:02 ads.go:37: Getting all requests...
2017/02/24 12:56:02 coaxerconfig.go:15: Running: get requests from cluster "right" (attempt 1)
2017/02/24 12:56:02 ads.go:68: Success: got all requests from cluster "right"
2017/02/24 12:56:02 ads.go:72: Got: 1 requests
2017/02/24 12:56:02 ads.go:92: Gathering data for request "192.168.99.100>2222>repos>sous-server::left" in background.
2017/02/24 12:56:02 coaxerconfig.go:15: Success: get requests from cluster "right" at attempt 1

bash-3.2$ unset SOUS_SERVER
bash-3.2$ unset SOUS_STATE_LOCATION
bash-3.2$ popd
/tmp/sous-work
bash-3.2$ 
bash-3.2$ 